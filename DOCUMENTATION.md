# ?? Tax NL2SQL Assistant - Complete Technical Documentation

> **Natural Language to SQL for Tax Management Database**  
> Powered by Azure OpenAI GPT-4 Turbo

An intelligent console application that converts natural language questions into SQL queries, executes them against a tax management database, and returns human-readable answers using advanced AI.

---

## ?? Table of Contents

- [Overview](#overview)
- [System Architecture](#system-architecture)
- [Technology Stack](#technology-stack)
- [Getting Started](#getting-started)
- [Data Flow](#data-flow)
- [Component Architecture](#component-architecture)
- [Prompt Engineering](#prompt-engineering)
- [Database Schema](#database-schema)
- [Configuration](#configuration)
- [Usage Examples](#usage-examples)
- [Design Patterns](#design-patterns)
- [Error Handling](#error-handling)
- [Extensibility](#extensibility)

---

## ?? Overview

**Tax NL2SQL Assistant** bridges the gap between natural language and database queries, enabling users to interact with tax data using plain English. The application leverages Azure OpenAI's GPT-4 to understand questions, generate optimized SQL queries, and provide conversational answers.

### Key Features

? **Natural Language Processing** - Ask questions in plain English  
? **Intelligent SQL Generation** - AI-generated, optimized T-SQL queries  
? **Conversational Responses** - Human-readable answers with context  
? **Chat History** - Maintains conversation context for follow-up questions  
? **Schema Awareness** - Understands database structure and relationships  
? **Production Ready** - Comprehensive error handling and validation

---

## ??? System Architecture

```
???????????????????????????????????????????????????????????????????????????????
?                         USER INTERACTION LAYER                              ?
?                                                                             ?
?  User enters natural language question:                                    ?
?  "Show me all taxpayers with income over $70,000 in 2024"                 ?
???????????????????????????????????????????????????????????????????????????????
                                   ?
                                   ?
???????????????????????????????????????????????????????????????????????????????
?                        APPLICATION LAYER (Program.cs)                       ?
?  ????????????????????????????????????????????????????????????????????????? ?
?  ?  1. Load Configuration (appsettings.json)                             ? ?
?  ?  2. Initialize Database Connection                                    ? ?
?  ?  3. Fetch Database Schema                                             ? ?
?  ?  4. Initialize Azure OpenAI Client                                    ? ?
?  ?  5. Handle User Commands & Chat Loop                                  ? ?
?  ????????????????????????????????????????????????????????????????????????? ?
??????????????????????????????????????????????????????????????????????????????
                 ?                    ?                    ?
                 ?                    ?                    ?
    ?????????????????????? ????????????????????? ????????????????????
    ?  Configuration     ? ?  Azure OpenAI     ? ?  Database        ?
    ?  Manager           ? ?  Service          ? ?  Helper          ?
    ?                    ? ?                   ? ?                  ?
    ?  • Validates       ? ?  • SQL Gen        ? ?  • Query Exec    ?
    ?  • Loads Settings  ? ?  • Answer Gen     ? ?  • Schema Fetch  ?
    ?  • Provides Config ? ?  • Chat History   ? ?  • Connection    ?
    ?????????????????????? ????????????????????? ????????????????????
                 ?                    ?                    ?
                 ?                    ?                    ?
    ?????????????????????? ????????????????????? ????????????????????
    ? appsettings.json   ? ? Azure OpenAI      ? ? SQL Server       ?
    ?                    ? ? GPT-4 Turbo       ? ? TaxManagementDB  ?
    ? • DB Connection    ? ?                   ? ?                  ?
    ? • Azure Endpoint   ? ? • Deployment:     ? ? • LocalDB        ?
    ? • API Key          ? ?   gpt-4.1         ? ? • Tables         ?
    ? • App Settings     ? ?                   ? ? • Relationships  ?
    ?????????????????????? ????????????????????? ????????????????????
```

---

## ?? Data Flow Diagram

```
????????????????
?   USER       ?
?   QUESTION   ? "Show me all taxpayers with refunds in 2024"
????????????????
       ?
       ?
????????????????????????????????????????????????????????????????????
? STEP 1: Load Database Schema                                     ?
? ???????????????????????????????????????????????????????????????? ?
? ? SchemaFetcher                                                ? ?
? ? • Queries INFORMATION_SCHEMA.COLUMNS                         ? ?
? ? • Fetches foreign key relationships                          ? ?
? ? • Formats schema for AI consumption                          ? ?
? ?                                                              ? ?
? ? Output Example:                                              ? ?
? ?   Table: dbo.TaxPayers                                       ? ?
? ?   - TaxPayerID: INT NOT NULL                                 ? ?
? ?   - FirstName: NVARCHAR(100) NOT NULL                        ? ?
? ?   - LastName: NVARCHAR(100) NOT NULL                         ? ?
? ?   ...                                                        ? ?
? ?                                                              ? ?
? ?   Relationships:                                             ? ?
? ?   TaxReturns.TaxPayerID ? TaxPayers.TaxPayerID             ? ?
? ???????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????
                           ?
                           ?
????????????????????????????????????????????????????????????????????
? STEP 2: Generate SQL Query (Azure OpenAI)                       ?
? ???????????????????????????????????????????????????????????????? ?
? ? AzureOpenAIService.GenerateSQLQueryAsync()                   ? ?
? ?                                                              ? ?
? ? Input Payload:                                               ? ?
? ?   • System Prompt: "You are a T-SQL expert..."              ? ?
? ?   • User Question: "Show me all taxpayers..."                ? ?
? ?   • Database Schema: [complete schema text]                  ? ?
? ?                                                              ? ?
? ? GPT-4 Configuration:                                         ? ?
? ?   • Temperature: 0.1 (highly deterministic)                  ? ?
? ?   • MaxTokens: 1000                                          ? ?
? ?   • TopP: 0.95                                               ? ?
? ?                                                              ? ?
? ? Output (Raw SQL):                                            ? ?
? ?   SELECT tp.FirstName, tp.LastName, tr.RefundAmount,        ? ?
? ?          tr.TaxYear                                          ? ?
? ?   FROM dbo.TaxPayers tp                                      ? ?
? ?   INNER JOIN dbo.TaxReturns tr                              ? ?
? ?     ON tp.TaxPayerID = tr.TaxPayerID                        ? ?
? ?   WHERE tr.TaxYear = 2024                                    ? ?
? ?     AND tr.RefundAmount > 0                                  ? ?
? ?   ORDER BY tr.RefundAmount DESC                              ? ?
? ???????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????
                           ?
                           ?
????????????????????????????????????????????????????????????????????
? STEP 3: Execute SQL Query                                        ?
? ???????????????????????????????????????????????????????????????? ?
? ? DatabaseHelper ? SqlServerQueryStrategy                      ? ?
? ?                                                              ? ?
? ? Process:                                                     ? ?
? ?   1. Establish connection to SQL Server                      ? ?
? ?   2. Create SqlCommand with 60s timeout                      ? ?
? ?   3. Execute query via SqlDataAdapter                        ? ?
? ?   4. Fill DataTable with results                             ? ?
? ?   5. Close connection (auto-pooled)                          ? ?
? ?                                                              ? ?
? ? Results (DataTable):                                         ? ?
? ?   ????????????????????????????????????????????????          ? ?
? ?   ?FirstName ? LastName ? RefundAmount ? TaxYear ?          ? ?
? ?   ????????????????????????????????????????????????          ? ?
? ?   ?Sarah     ? Johnson  ? 3500.00      ? 2024    ?          ? ?
? ?   ?John      ? Doe      ? 1200.00      ? 2024    ?          ? ?
? ?   ????????????????????????????????????????????????          ? ?
? ???????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????
                           ?
                           ?
????????????????????????????????????????????????????????????????????
? STEP 4: Format Results for AI                                    ?
? ???????????????????????????????????????????????????????????????? ?
? ? ResultFormatter.FormatDataTableForAI()                       ? ?
? ?                                                              ? ?
? ? Converts DataTable to CSV-style text:                        ? ?
? ?                                                              ? ?
? ?   FirstName, LastName, RefundAmount, TaxYear                 ? ?
? ?   Sarah, Johnson, 3500.00, 2024                              ? ?
? ?   John, Doe, 1200.00, 2024                                   ? ?
? ???????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????
                           ?
                           ?
????????????????????????????????????????????????????????????????????
? STEP 5: Generate Natural Language Answer                        ?
? ???????????????????????????????????????????????????????????????? ?
? ? AzureOpenAIService.GenerateAnswerAsync()                     ? ?
? ?                                                              ? ?
? ? Input Payload:                                               ? ?
? ?   • System: "You are a helpful tax assistant..."            ? ?
? ?   • Original Question: "Show me all taxpayers..."            ? ?
? ?   • SQL Query: [the generated SQL]                           ? ?
? ?   • Query Results: [CSV formatted data]                      ? ?
? ?                                                              ? ?
? ? GPT-4 Configuration:                                         ? ?
? ?   • Temperature: 0.7 (conversational)                        ? ?
? ?   • MaxTokens: 500                                           ? ?
? ?                                                              ? ?
? ? Output (Natural Language):                                   ? ?
? ?   "In 2024, 2 taxpayers received tax refunds:               ? ?
? ?    • Sarah Johnson received $3,500.00                        ? ?
? ?    • John Doe received $1,200.00                             ? ?
? ?    The total refunds issued were $4,700.00."                ? ?
? ???????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????
                           ?
                           ?
????????????????????????????????????????????????????????????????????
? STEP 6: Display to User                                          ?
? ???????????????????????????????????????????????????????????????? ?
? ? Console Output                                               ? ?
? ?                                                              ? ?
? ? ??????????????????????????????????????????????????????????? ? ?
? ? ?? Answer:                                                   ? ?
? ? ??????????????????????????????????????????????????????????? ? ?
? ? In 2024, 2 taxpayers received tax refunds:                  ? ?
? ?  • Sarah Johnson received $3,500.00                          ? ?
? ?  • John Doe received $1,200.00                               ? ?
? ?  The total refunds issued were $4,700.00.                   ? ?
? ? ??????????????????????????????????????????????????????????? ? ?
? ???????????????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????????????
```

---

## ??? Technology Stack

### Core Technologies

| Technology | Version | Purpose |
|------------|---------|---------|
| **.NET** | 8.0 | Runtime framework |
| **C#** | 12.0 | Programming language |
| **SQL Server LocalDB** | Latest | Database engine |
| **Azure OpenAI** | GPT-4 Turbo | AI language model |

### NuGet Packages

```xml
<PackageReference Include="Azure.AI.OpenAI" Version="2.1.0" />
<PackageReference Include="Azure.Identity" Version="1.17.1" />
<PackageReference Include="Microsoft.Data.SqlClient" Version="6.1.3" />
<PackageReference Include="Microsoft.Extensions.Configuration" Version="10.0.1" />
<PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="10.0.1" />
<PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="10.0.1" />
```

---

## ?? Getting Started

### Prerequisites

- .NET 8.0 SDK
- SQL Server LocalDB (or SQL Server instance)
- Azure OpenAI account with GPT-4 deployment
- Visual Studio 2022 or VS Code

### Installation Steps

1. **Navigate to project directory**
   ```bash
   cd C:\Users\AF562UL\OneDrive - EY\Desktop\NL2SQL\TaxNL2SQL
   ```

2. **Configure appsettings.json**
   ```json
   {
     "ConnectionStrings": {
       "TaxManagementDB": "Server=(localdb)\\MSSQLLocalDB;Database=TaxManagementDB;Integrated Security=true;TrustServerCertificate=True;"
     },
     "AzureOpenAI": {
       "Endpoint": "https://YOUR-RESOURCE.openai.azure.com/",
       "ApiKey": "YOUR-API-KEY-HERE",
       "DeploymentName": "gpt-4"
     },
     "Application": {
       "ShowSQLQuery": true,
       "ShowRawResults": false,
       "EnableChatHistory": true,
       "MaxHistoryMessages": 10
     }
   }
   ```

3. **Build and run**
   ```bash
   dotnet restore
   dotnet build
   dotnet run
   ```

---

## ?? Component Architecture

```
TaxNL2SQL/
?
??? ?? Configuration/
?   ??? ConfigurationManager.cs
?       ??? Loads appsettings.json using ConfigurationBuilder
?       ??? Validates all required settings on startup
?       ??? Provides strongly-typed access to settings
?       ??? Methods:
?           • GetConnectionString()
?           • GetAzureOpenAIEndpoint()
?           • GetAzureOpenAIApiKey()
?           • GetDeploymentName()
?           • ShowSQLQuery()
?           • ShowRawResults()
?           • ValidateConfiguration()
?
??? ?? Services/
?   ??? AzureOpenAIService.cs
?       ??? Manages ChatClient instance
?       ??? Maintains conversation history
?       ??? System prompt engineering
?       ??? Methods:
?           • GenerateSQLQueryAsync(question, schema)
?           • GenerateAnswerAsync(question, sql, results)
?           • ClearHistory()
?           • GetHistoryCount()
?
??? ?? Data/
?   ??? IQueryStrategy.cs (Interface)
?   ?   ??? Abstract database operations
?   ?
?   ??? SqlServerQueryStrategy.cs (Implementation)
?   ?   ??? ExecuteQuery(sql) ? DataTable
?   ?   ??? ExecuteNonQuery(sql) ? int
?   ?   ??? ExecuteScalar(sql) ? object
?   ?   ??? TestConnection() ? bool
?   ?
?   ??? DatabaseHelper.cs (Facade)
?       ??? Wrapper over IQueryStrategy
?           • GetDataTable(query)
?           • ExecuteCommand(command)
?           • GetScalarValue(query)
?           • TestConnection()
?
??? ?? Utils/
?   ??? SchemaFetcher.cs
?   ?   ??? Fetches schema from INFORMATION_SCHEMA
?   ?   ??? Retrieves foreign key relationships
?   ?   ??? Methods:
?   ?       • FetchDatabaseSchema()
?   ?       • FetchSchemaWithRelationships()
?   ?       • GetTableSummary()
?   ?
?   ??? ResultFormatter.cs
?       ??? Formats output for console display
?       ??? Methods:
?           • FormatDataTable(dataTable)
?           • FormatDataTableForAI(dataTable)
?           • FormatSQLQuery(sql)
?           • FormatError(message)
?           • FormatSuccess(message)
?
??? Program.cs
?   ??? Main application orchestration
?       • Startup sequence
?       • Command handling
?       • Main chat loop
?
??? appsettings.json
?   ??? Configuration file
?
??? TaxNL2SQL.csproj
    ??? Project dependencies & settings
```

---

## ?? Prompt Engineering (Meta-Prompts)

### Two-Phase Prompt Strategy

The application uses **advanced prompt engineering** with different configurations for different tasks:

### Phase 1: SQL Generation (Deterministic)

**System Prompt (Meta-Prompt for SQL Generation):**

```
# ROLE:
You are a highly intelligent T-SQL expert assistant specializing in tax management databases.
Your task is to generate precise, efficient, and optimized T-SQL queries based on the 
provided database schema and user requirements.

# INSTRUCTIONS:
1. Return ONLY the T-SQL query without any explanation, comments, or additional text
2. Do NOT include markdown code blocks, backticks, or 'sql' language identifiers
3. Ensure queries are optimized and follow SQL Server best practices
4. Use proper JOINs instead of subqueries when possible
5. Always use table aliases for readability
6. Include appropriate WHERE clauses to filter data efficiently
7. Use aggregate functions (SUM, COUNT, AVG, etc.) when appropriate
8. Format dates properly using SQL Server date functions
9. For year-based queries, use the TaxYear column in TaxReturns table
10. Always use schema prefix 'dbo.' before table names

# OUTPUT FORMAT:
- Return only the raw SQL query text
- NO explanations before or after the query
- NO code block markers
- NO comments in the SQL

# IMPORTANT DATABASE NOTES:
- Tax returns are stored in dbo.TaxReturns table with TaxYear column
- All monetary amounts are DECIMAL(18,2)
- Use GETDATE() for current date comparisons
- Primary tables: TaxPayers, TaxReturns, Incomes, Deductions, TaxCredits, TaxPayments
- Always join through proper foreign key relationships

If the user request is unclear or ambiguous, return only: 
'CLARIFICATION NEEDED: [specific question]'
```

**Configuration:**
```csharp
Temperature: 0.1        // Highly deterministic
MaxTokens: 1000         // Enough for complex queries
TopP: 0.95              // Focused sampling
```

**Why This Works:**
- **Low temperature (0.1)** ensures consistent, predictable SQL generation
- **Explicit formatting rules** prevent markdown contamination
- **Schema awareness** in prompt enables proper table/column references
- **Best practices** baked into prompt ensure optimized queries

---

### Phase 2: Answer Generation (Conversational)

**System Prompt:**

```
You are a helpful tax assistant. Provide clear, accurate answers based on the data provided.
```

**User Message Structure:**
```
The user asked: "{userQuestion}"

The SQL query executed was:
{sqlQuery}

Query Results:
{queryResults}

Provide a clear, concise natural language answer to the user's question based on the results. 
Be specific with numbers and names. Keep the response conversational and easy to understand.
```

**Configuration:**
```csharp
Temperature: 0.7        // More creative/conversational
MaxTokens: 500          // Concise answers
```

**Why This Works:**
- **Higher temperature (0.7)** enables natural, conversational responses
- **Context injection** provides all necessary data for accurate answers
- **Explicit instructions** for clarity and specificity

---

### Prompt Engineering Best Practices Used

#### 1. **Role Assignment**
```
"You are a highly intelligent T-SQL expert..."
```
Establishes clear expertise domain and expected behavior.

#### 2. **Output Format Specification**
```
"Return ONLY the T-SQL query without any explanation..."
"Do NOT include markdown code blocks..."
```
Prevents common AI formatting issues.

#### 3. **Constraint Definition**
```
"Always use schema prefix 'dbo.' before table names"
"Use proper JOINs instead of subqueries when possible"
```
Enforces code quality standards.

#### 4. **Context Injection**
```
Database Schema:
{databaseSchema}
```
Provides dynamic context for schema-aware generation.

#### 5. **Fallback Handling**
```
"If the user request is unclear or ambiguous, return only: 
'CLARIFICATION NEEDED: [specific question]'"
```
Graceful degradation for ambiguous inputs.

#### 6. **Temperature Tuning**
- **SQL Generation**: 0.1 (deterministic, consistent)
- **Answer Generation**: 0.7 (natural, conversational)

#### 7. **Token Management**
- **SQL**: 1000 tokens (handles complex multi-table queries)
- **Answers**: 500 tokens (concise, focused responses)

---

### Example Prompt Flow

**User Input:**
```
"Show me taxpayers with income over $70,000"
```

**SQL Generation Prompt (Sent to Azure OpenAI):**
```
[System: T-SQL Expert Prompt...]

User Question: Show me taxpayers with income over $70,000

Database Schema:
Table: dbo.TaxPayers
- TaxPayerID: INT NOT NULL
- FirstName: NVARCHAR(100) NOT NULL
- LastName: NVARCHAR(100) NOT NULL
...

Table: dbo.TaxReturns
- ReturnID: INT NOT NULL
- TaxPayerID: INT NOT NULL
- GrossIncome: DECIMAL(18,2) NOT NULL
...

Generate the T-SQL query:
```

**AI Response (SQL):**
```sql
SELECT tp.FirstName, tp.LastName, tr.GrossIncome
FROM dbo.TaxPayers tp
INNER JOIN dbo.TaxReturns tr ON tp.TaxPayerID = tr.TaxPayerID
WHERE tr.GrossIncome > 70000
ORDER BY tr.GrossIncome DESC
```

**Answer Generation Prompt (Sent to Azure OpenAI):**
```
[System: Helpful tax assistant...]

The user asked: "Show me taxpayers with income over $70,000"

The SQL query executed was:
SELECT tp.FirstName, tp.LastName, tr.GrossIncome...

Query Results:
FirstName, LastName, GrossIncome
Michael, Chen, 95000.00
Sarah, Johnson, 85000.00
...
```

**AI Response (Natural Language):**
```
I found 2 taxpayers with income over $70,000:
• Michael Chen with $95,000.00
• Sarah Johnson with $85,000.00
```

---

## ??? Database Schema

### Entity-Relationship Diagram

```
??????????????????????????
?     TaxPayers          ?
??????????????????????????
? TaxPayerID (PK)        ????????????
? FirstName              ?          ?
? LastName               ?          ? 1
? SSN                    ?          ?
? Email                  ?          ?
? PhoneNumber            ?          ?
? DateOfBirth            ?          ?
? FilingStatus           ?          ?
? Address                ?          ?
? City                   ?          ?
? State                  ?          ?
? ZipCode                ?          ?
??????????????????????????          ?
                                    ?
                                    ? N
??????????????????????????          ?
?     TaxReturns         ?          ?
??????????????????????????          ?
? ReturnID (PK)          ?          ?
? TaxPayerID (FK)        ????????????
? TaxYear                ?
? FilingDate             ?
? GrossIncome            ?
? AdjustedGrossIncome    ?
? TaxableIncome          ?
? TotalTax               ?
? TotalCredits           ?
? RefundAmount           ?
? AmountDue              ?
? Status                 ?
??????????????????????????
             ?
             ? 1
             ?
      ?????????????????????????????????????
      ?             ?          ?          ?
      ? N           ? N        ? N        ? N
      ?             ?          ?          ?
???????????? ????????????? ????????????? ???????????????
? Incomes  ? ?Deductions ? ?TaxCredits ? ?TaxPayments  ?
???????????? ????????????? ????????????? ???????????????
? IncomeID ? ?DeductionID? ?CreditID   ? ?PaymentID    ?
? ReturnID ? ?ReturnID   ? ?ReturnID   ? ?ReturnID     ?
? Type     ? ?Type       ? ?Type       ? ?PaymentDate  ?
? Amount   ? ?Amount     ? ?Amount     ? ?Amount       ?
? Source   ? ?Category   ? ?Percentage ? ?Method       ?
???????????? ????????????? ????????????? ???????????????
```

### Table Descriptions

#### **TaxPayers**
Stores taxpayer personal information.

| Column | Type | Description |
|--------|------|-------------|
| TaxPayerID | INT | Primary key, auto-increment |
| FirstName | NVARCHAR(100) | Taxpayer's first name |
| LastName | NVARCHAR(100) | Taxpayer's last name |
| SSN | NVARCHAR(11) | Social Security Number |
| Email | NVARCHAR(255) | Contact email |
| FilingStatus | NVARCHAR(20) | Single, Married, etc. |

#### **TaxReturns**
Stores tax return information per year.

| Column | Type | Description |
|--------|------|-------------|
| ReturnID | INT | Primary key, auto-increment |
| TaxPayerID | INT | Foreign key to TaxPayers |
| TaxYear | INT | Tax year (e.g., 2024) |
| GrossIncome | DECIMAL(18,2) | Total income before deductions |
| RefundAmount | DECIMAL(18,2) | Refund amount (if positive) |

---

## ?? Configuration

### appsettings.json Structure

```json
{
  "ConnectionStrings": {
    "TaxManagementDB": "Server=(localdb)\\MSSQLLocalDB;Database=TaxManagementDB;Integrated Security=true;TrustServerCertificate=True;MultipleActiveResultSets=true;"
  },
  "AzureOpenAI": {
    "Endpoint": "https://your-resource.openai.azure.com/",
    "ApiKey": "your-api-key-here",
    "DeploymentName": "gpt-4"
  },
  "Application": {
    "ShowSQLQuery": true,
    "ShowRawResults": false,
    "EnableChatHistory": true,
    "MaxHistoryMessages": 10
  }
}
```

### Configuration Options

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `ShowSQLQuery` | bool | true | Display generated SQL in console |
| `ShowRawResults` | bool | false | Display raw DataTable results |
| `EnableChatHistory` | bool | true | Maintain conversation context |
| `MaxHistoryMessages` | int | 10 | Maximum messages in history |

---

## ?? Usage Examples

### Example 1: Simple Query

**Input:**
```
?? Your Question: Who has the highest tax liability?
```

**Output:**
```
? Processing your question...

?? Generated SQL Query:
????????????????????????????????????????????????????????????????????????????????
SELECT TOP 1 tp.FirstName, tp.LastName, tr.TotalTax
FROM dbo.TaxPayers tp
INNER JOIN dbo.TaxReturns tr ON tp.TaxPayerID = tr.TaxPayerID
ORDER BY tr.TotalTax DESC
????????????????????????????????????????????????????????????????????????????????

??  Executing query...
?? Generating answer...

????????????????????????????????????????????????????????????????????????????????
?? Answer:
????????????????????????????????????????????????????????????????????????????????
Michael Chen has the highest tax liability with a total tax of $28,500.00.
????????????????????????????????????????????????????????????????????????????????
```

### Example 2: Aggregate Query

**Input:**
```
?? Your Question: What is the total income by filing status?
```

**Output:**
```
????????????????????????????????????????????????????????????????????????????????
?? Answer:
????????????????????????????????????????????????????????????????????????????????
Here's the breakdown of total income by filing status:

• Married Filing Jointly: $350,000.00
• Single: $275,000.00
• Head of Household: $120,000.00
• Married Filing Separately: $85,000.00
????????????????????????????????????????????????????????????????????????????????
```

### Special Commands

| Command | Action |
|---------|--------|
| `help` | Display instructions and examples |
| `schema` | Show complete database schema |
| `clear` | Clear chat history and screen |
| `exit` or `quit` | Exit the application |
| `[Enter]` | Exit the application |

---

## ?? Design Patterns

### 1. Strategy Pattern (Data Access)

```csharp
// Interface
public interface IQueryStrategy
{
    DataTable ExecuteQuery(string query);
    int ExecuteNonQuery(string command);
    object ExecuteScalar(string query);
    bool TestConnection();
}

// Implementation
public class SqlServerQueryStrategy : IQueryStrategy
{
    // SQL Server-specific implementation
}

// Future: Add MySQL, PostgreSQL, etc.
```

### 2. Facade Pattern (Database Helper)

```csharp
public class DatabaseHelper
{
    private readonly IQueryStrategy _queryStrategy;
    
    // Simplified API
    public DataTable GetDataTable(string query)
    public int ExecuteCommand(string command)
    public object GetScalarValue(string query)
    public bool TestConnection()
}
```

### 3. Builder Pattern (Configuration)

```csharp
var configuration = new ConfigurationBuilder()
    .SetBasePath(AppDomain.CurrentDomain.BaseDirectory)
    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
    .Build();
```

---

## ??? Error Handling

### Error Hierarchy

```
Application Errors
?
??? Configuration Errors
?   ??? InvalidOperationException
?   ?   ? Missing/invalid config values
?   ?   ? Action: Display error, instructions, exit
?
??? Database Errors
?   ??? SqlException
?   ?   ? Connection failures, query errors, timeouts
?   ?   ? Action: Log details, format error, continue loop
?
??? Azure OpenAI Errors
?   ??? RequestFailedException
?   ?   ? API errors (401, 429, 500)
?   ?   ? Action: Display status code, continue loop
?
??? Query Execution Errors
    ??? InvalidOperationException
        ? Generated SQL errors
        ? Action: Suggest rephrasing, continue loop
```

---

## ?? Extensibility

### Adding a New Database Provider

```csharp
public class PostgreSqlQueryStrategy : IQueryStrategy
{
    public DataTable ExecuteQuery(string query)
    {
        using var connection = new NpgsqlConnection(_connectionString);
        using var adapter = new NpgsqlDataAdapter(query, connection);
        var dataTable = new DataTable();
        adapter.Fill(dataTable);
        return dataTable;
    }
}

// Use in Program.cs
var queryStrategy = new PostgreSqlQueryStrategy(connectionString);
var databaseHelper = new DatabaseHelper(queryStrategy);
```

---

## ?? Performance Characteristics

| Metric | Value | Notes |
|--------|-------|-------|
| **Query Timeout** | 60 seconds | Configurable in SqlCommand |
| **AI Response Time** | 2-5 seconds | Varies by model load |
| **Database Connection** | Pooled | Auto-managed by ADO.NET |
| **Chat History** | 10 messages | Configurable in appsettings |
| **Max SQL Tokens** | 1000 | Handles complex queries |
| **Max Answer Tokens** | 500 | Concise responses |

---

## ?? Troubleshooting

**Issue:** "Failed to connect to database"  
**Solution:** Verify SQL Server LocalDB is running: `sqllocaldb info`

**Issue:** "Azure OpenAI API Error 401"  
**Solution:** Verify API key and endpoint URL in appsettings.json

**Issue:** "Generated SQL syntax error"  
**Solution:** Use `schema` command to verify database structure

---

## ?? Additional Resources

- [Azure OpenAI Documentation](https://learn.microsoft.com/en-us/azure/ai-services/openai/)
- [Prompt Engineering Guide](https://learn.microsoft.com/en-us/azure/ai-services/openai/concepts/prompt-engineering)
- [.NET 8 Documentation](https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-8)

---

## ?? Project Information

**Workspace Location:** `C:\Users\AF562UL\OneDrive - EY\Desktop\NL2SQL\`  
**Target Framework:** .NET 8.0  
**C# Version:** 12.0  
**Database:** SQL Server LocalDB / TaxManagementDB

---

## ?? Learning Outcomes

By studying this project, you'll learn:

? How to integrate Azure OpenAI with .NET applications  
? **Effective prompt engineering for code generation (Meta-Prompts)**  
? Clean architecture with SOLID principles  
? Strategy and Facade design patterns  
? Async/await patterns for AI API calls  
? Configuration management in .NET  
? Error handling and user experience design  
? Natural language to SQL conversion techniques

---

**Built with ?? using .NET 8 and Azure OpenAI**
